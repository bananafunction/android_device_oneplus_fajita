From 934145f46a2e2898609e97d6574782f7dd6a7719 Mon Sep 17 00:00:00 2001
From: Dyneteve <dyneteve@hentaios.com>
Date: Sun, 31 Jan 2021 05:45:56 +0900
Subject: [PATCH] keystore: Report rate limited instead of not implemented

Change-Id: I9577a24dce32183a9742a5020cb06a3022809f60
Signed-off-by: Anushek Prasal <anushekprasal@gmail.com>
---
 keystore/key_store_service.cpp       | 4 ++--
 keystore/keystore_attestation_id.cpp | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/keystore/key_store_service.cpp b/keystore/key_store_service.cpp
index b1f1304..9f34303 100644
--- a/keystore/key_store_service.cpp
+++ b/keystore/key_store_service.cpp
@@ -121,8 +121,8 @@ KeyStoreServiceReturnCode updateParamsForAttestation(uid_t callingUid, Authoriza
 
     auto asn1_attestation_id_result = security::gather_attestation_application_id(callingUid);
     if (!asn1_attestation_id_result.isOk()) {
-        if (asn1_attestation_id_result.status() == KM_ERROR_UNIMPLEMENTED) {
-            return KeyStoreServiceReturnCode(KM_ERROR_UNIMPLEMENTED);
+        if (asn1_attestation_id_result.status() == KM_ERROR_KEY_RATE_LIMIT_EXCEEDED) {
+            return KeyStoreServiceReturnCode(KM_ERROR_KEY_RATE_LIMIT_EXCEEDED);
         } else {
             ALOGE("failed to gather attestation_id");
             // Couldn't get attestation ID; just use an empty one rather than failing.
diff --git a/keystore/keystore_attestation_id.cpp b/keystore/keystore_attestation_id.cpp
index 448a909..c3ea7b7 100644
--- a/keystore/keystore_attestation_id.cpp
+++ b/keystore/keystore_attestation_id.cpp
@@ -214,7 +214,7 @@ build_attestation_application_id(const KeyAttestationApplicationId& key_attestat
         std::string package_name(String8(*pinfo->package_name()).string());
         // Prevent Google Play Services from using key attestation for SafetyNet
         if (package_name == "com.google.android.gms") {
-            return KM_ERROR_UNIMPLEMENTED;
+            return KM_ERROR_KEY_RATE_LIMIT_EXCEEDED;
         }
         std::unique_ptr<KM_ATTESTATION_PACKAGE_INFO> attestation_package_info;
         auto rc = build_attestation_package_info(*pinfo, &attestation_package_info);
-- 
2.25.1

